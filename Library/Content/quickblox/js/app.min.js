(function(n,t,i,r,u){"use strict";u(function(){function k(n){var t=0;return n.indexOf("uc_")!=-1&&(t=n.substring(3,n.length)),t}function a(n){return new Promise(function(i,r){t.webrtc.getMediaDevices(n).then(function(t){var s=n==="videoinput",h=s?u(f.videoSourceFilter):u(f.audioSourceFilter),r,e,o;if(h.empty(),t.length){for(r=0;r!==t.length;++r)e=t[r],o=document.createElement("option"),o.value=e.deviceId,e.kind===n&&(o.text=e.label||(s?"Camera ":"Mic ")+(r+1),h.append(o));u(".j-media_sources").removeClass("invisible")}else u(".j-media_sources").addClass("invisible");i()}).catch(function(n){console.warn("getMediaDevices",n);r()})})}function d(){return new Promise(function(n){navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(function(t){a("videoinput").then(function(){return a("audioinput")}).then(function(){t.getTracks().forEach(function(n){n.stop()});n()})}).catch(function(t){console.warn("Video devices were shown without names (getUserMedia error)",t);a("videoinput").then(function(){return a("audioinput")}).then(function(){n()})})})}function g(n){u.get("/Company/OnlineCareerFair/GetCandidateNote?candidateId="+n,function(n){console.log(n.Notes);u("#videoscreen-conversationnote").val(n.Notes)})}var p=null,s={call:"callingSignal",end:"endCallSignal",rington:"ringtoneSignal"},o=null,c,nt={onstart:function(){u(".j-record").addClass("active");c=setTimeout(function(){o&&o.stop()},6e5)},onstop:function(n){u(".j-record").removeClass("active");var t=confirm("Do you want to download video?");t&&o.download("QB_WEBrtc_sample"+Date.now(),n);o=null;clearTimeout(c)},onerror:function(n){console.error("Recorder error",n)}},h=!1,f={income_call:"#videoCall",filterSelect:".j-filter",videoSourceFilter:".j-video_source",audioSourceFilter:".j-audio_source",bandwidthSelect:".j-bandwidth",insertOccupants:function(n=true){function r(n,t,i){i&&n.empty();n.append(t).removeClass("wait")}var t=u(".j-users");return new Promise(function(u,f){t.addClass("wait");i.helpers.renderUsers().then(function(i){r(t,i.usersHTML,n);u(i.users)},function(u){n?r(t,u.message,n):(t.removeClass("wait"),i.helpers.renderUsers.stop=!0);f("Not found users")})})}},w,v,e,b,l,y;if(t.init(r.CREDENTIALS.appId,r.CREDENTIALS.authKey,r.CREDENTIALS.authSecret,r.APP_CONFIG),w=_.invert(t.webrtc.PeerConnectionState),!t.webrtc){alert("Error: "+r.MESSAGES.webrtc_not_avaible);return}if(!_.isEmpty(i.caller))return!1;if(i.helpers.setFooterPosition(),i.caller={},i.callees={},i.calleesAnwered=[],i.calleesRejected=[],i.users=[],v=JSON.parse(localStorage.getItem("data")),v&&u(".j-join__username").val(v.username),e={callTime:0,callTimer:null,updTimer:function(){this.callTime+=1e3;u("#timer").removeClass("invisible").text(new Date(this.callTime).toUTCString().split(/ /)[4])}},b=0,d(),l=parseInt(u("[id$=hdnCurrentUserID]").val()),y={username:"um_"+l,login:"topm"+l,externaluserid:l},localStorage.setItem("data",JSON.stringify(y)),!n.navigator.onLine)return alert(r.MESSAGES.no_internet),!1;localStorage.getItem("isAuth");i.helpers.join(y).then(function(n){i.caller=n;t.chat.connect({jid:t.chat.helpers.getUserJid(i.caller.id,r.CREDENTIALS.appId),password:"quickblox"},function(n){n?(_.isEmpty(i.currentSession)||(i.currentSession.stop({}),i.currentSession={}),i.helpers.changeFilter("#localVideo","no"),i.helpers.changeFilter("#main_video","no"),i.mainVideo=0,u(f.filterSelect).val("no"),i.calleesAnwered=[],i.calleesRejected=[],e.callTimer&&(u("#timer").addClass("invisible"),clearInterval(e.callTimer),e.callTimer=null,e.callTime=0,i.helpers.network={})):localStorage.setItem("isAuth",!0)})}).catch(function(n){try{typeof n.message=="string"?u("#join_err").find(".error",0).text(n.message):u("#join_err").find(".error",0).text(n.message.errors.base[0])}catch(t){console.log(n)}u("#join_err").modal()});u(document).on("click",".j-caller__ctrl",function(){var n=u(this),t=n.hasClass("active");if(_.isEmpty(i.currentSession)||n.data("target")=="screen")return!1;t?(n.removeClass("active"),i.currentSession.unmute(n.data("target")),n.data("target")=="video"?u('.j-caller__ctrl[data-target="'+n.data("target")+'"] img').attr("src","https://img.icons8.com/ios/30/000000/video-call.png").attr("title","Kamerayı kapat"):u('.j-caller__ctrl[data-target="'+n.data("target")+'"] img').attr("src","https://img.icons8.com/ios-glyphs/30/000000/microphone.png").attr("title","Mikrofonu kapat")):(n.addClass("active"),i.currentSession.mute(n.data("target")),n.data("target")=="video"?u('.j-caller__ctrl[data-target="'+n.data("target")+'"] img').attr("src","https://img.icons8.com/ios/30/000000/no-video.png").attr("title","Kamerayı aç"):u('.j-caller__ctrl[data-target="'+n.data("target")+'"] img').attr("src","https://img.icons8.com/ios-glyphs/30/000000/no-microphone.png").attr("title","Mikrofonu aç"))});u(document).on("click",".btn-end-call,.returnchat",function(){if(u(this).hasClass("calling")){if(!_.isEmpty(i.currentSession))return o&&c&&o.stop(),i.currentSession.stop({}),i.currentSession={},i.helpers.setFooterPosition(),u("#video-content").remove(),u(".btn.call-actions.video-call").show(),u("#onvideocall").modal("hide"),u(".btn-end-call").hide(),!1}else{const n=Swal.mixin({customClass:{confirmButton:"exit-queueconversation",cancelButton:"continue-queueconversation"},buttonsStyling:!1});n.fire({text:"Video görüşmeyi sonlandırdığınızda chat ekranına dönüş yaparsınız. Görüşmeye yazılı olarak devam edebilirsiniz.",showCancelButton:!0,confirmButtonText:"ONAYLA",cancelButtonText:'VAZGEÇ<i class="btn-arrow"><\/i>',reverseButtons:!1}).then(n=>{if(n.value&&!_.isEmpty(i.currentSession))return o&&c&&o.stop(),i.currentSession.stop({}),i.currentSession={},i.helpers.setFooterPosition(),u("#video-content").remove(),u(".btn.call-actions.video-call").show(),u("#onvideocall").modal("hide"),u(".btn-end-call").hide(),!1})}});u(document).on("click",".j-decline",function(){_.isEmpty(i.currentSession)||(i.currentSession.reject({}),u(f.income_call).modal("hide"),document.getElementById(s.rington).pause())});u(document).on("click",".j-accept",function(){var n,r,e,o;h=i.currentSession.callType===t.webrtc.CallType.AUDIO;n=u(f.videoSourceFilter);r=u(f.audioSourceFilter);h||(e={audio:{deviceId:r.val()?r.val():undefined},video:{deviceId:n.val()?{exact:n.val()}:undefined},elemId:"localVideo",options:{muted:!0,mirror:!0}});o="";u(f.income_call).modal("hide");document.getElementById(s.rington).pause();i.currentSession.getUserMedia(e,function(n,t){if(!n&&t.getAudioTracks().length&&(h?!0:t.getVideoTracks().length))i.currentSession.attachMediaStream("main_video",t),u("#modal-video").modal(),u(".btn-end-call").show(),u(f.bandwidthSelect).attr("disabled",!0),i.helpers.setFooterPosition(),i.currentSession.accept({});else i.currentSession.stop({}),u(".btn.call-actions.video-call").show()})});u(document).on("click",".btn-savenotes",function(){console.log("clicked btn-savenotes");var n=u(".btn-savenotes").data("candidateId"),t=u("#videoscreen-conversationnote").val();u.ajax({url:"/Company/OnlineCareerFair/SaveNote",type:"Post",data:{candidateId:n,Note:t,networkingID:u("#Networking_NetworkingID").val()},success:function(n){n!=null&&n.Status==200&&(toastr.success("Notunuz kaydedildi."),console.log("200"))}})});u(document).on("click",".video-call",function(){var e=u("li.contact.active img.user-photo").attr("src"),r=u(".contact.active .info .name").html();u(".c-name").empty().text(r);u("#onvideocall .photo").attr("src",e);u("#onvideocall").modal("show");u(".btn-end-call").show();var l=u("li.contact.active").prop("id"),a="topc"+l,v={login:a};t.users.get(v,function(e,l){if(i.callees[l.id]=r,!e){var a=u(this),v=u(f.videoSourceFilter),y=u(f.audioSourceFilter),w=u(f.bandwidthSelect),p={audio:{deviceId:y.val()?y.val():undefined},video:{deviceId:v.val()?{exact:v.val()}:undefined},options:{muted:!0,mirror:!0},elemId:"localVideo"};if(a.hasClass("hangup")){if(!_.isEmpty(i.currentSession))return o&&c&&o.stop(),i.currentSession.stop({}),i.currentSession={},u(".btn.call-actions.video-call").show(),i.helpers.setFooterPosition(),!1}else{if(_.isEmpty(i.callees))return u("#error_no_calles").modal(),!1;h=a.data("call")==="audio";i.currentSession=t.webrtc.createNewSession(Object.keys(i.callees),h?t.webrtc.CallType.AUDIO:t.webrtc.CallType.VIDEO,null,{bandwidth:2048});i.currentSession.getUserMedia(p,function(t,r){var o,f,e;!t&&r.getAudioTracks().length&&(h?!0:r.getVideoTracks().length)?(f={},h&&(f.callType=2),e=[],i.currentSession.call({},function(){n.navigator.onLine?(document.getElementById(s.call).play(),Object.keys(i.callees).forEach(function(n){e.push(n)}),u(".btn.call-actions.video-call").hide(),u(".btn-end-call").show(),u("#local-videocontent").show(),i.helpers.setFooterPosition()):(console.log("window.navigator.onLine"),i.currentSession.stop({}))})):(o="",i.currentSession.stop({}))})}}})});t.webrtc.onCallListener=function(n,r){console.group("onCallListener.");console.log("Session: ",n);console.log("Extension: ",r);console.groupEnd();i.currentSession=n;console.log(n);t.users.get(Number(n.initiatorID),function(n,r){if(n)console.log(n);else{i.users=i.users.filter(function(n){return r.id!==n.id});i.users.push(r);u(f.income_call).modal("hide");console.log("user");console.log(r);var e=k(r.full_name),o="deff",h="";e&&(o=u("#"+e).find(".name").html(),h=u("#"+e).find(".user-photo").attr("src"));u(".j-ic_initiator").text(o);u(".j-ic_initiator-photo").attr("src",h);i.currentSession.state!==t.webrtc.SessionConnectionState.CLOSED&&(u(f.income_call).modal("show"),document.getElementById(s.rington).play())}})};t.webrtc.onSessionCloseListener=function(n){console.log("onSessionCloseListener: ",n);document.getElementById(s.call).pause();document.getElementById(s.end).play();u("#modal-video").modal("hide");u(".j-caller__ctrl").removeClass("active");u('.j-caller__ctrl[data-target="video"] img').attr("src","https://img.icons8.com/ios/30/000000/video-call.png").attr("title","Kamerayı kapat");u('.j-caller__ctrl[data-target="audio"] img').attr("src","https://img.icons8.com/ios-glyphs/30/000000/microphone.png").attr("title","Mikrofonu kapat");u("#videoCall").modal("hide");document.getElementById(s.rington).pause();u(".btn-end-call").hide();clearInterval(p);u(f.bandwidthSelect).attr("disabled",!1);i.currentSession.detachMediaStream("main_video");i.currentSession.detachMediaStream("localVideo");b=0;n.opponentsIDs.length>1;document.querySelector(".j-actions[hidden]")&&document.querySelector(".j-actions[hidden]").removeAttribute("hidden");document.querySelector(".j-caller__ctrl")&&document.querySelector(".j-caller__ctrl").removeAttribute("hidden")};t.webrtc.onStopCallListener=function(n,t,i){console.group("onStopCallListener.");console.log("UserId: ",t);console.log("Session: ",n);console.log("Extension: ",i);console.groupEnd();u("#modal-video").modal("hide");u(".btn-end-call").hide();u(f.income_call).modal("hide");document.getElementById(s.rington).pause();u(".btn.call-actions.video-call").show();o&&o.stop()};t.webrtc.onRejectCallListener=function(n,t,r){console.log("onRejectCallListener.");u("#modal-video").modal("hide");u(".btn-end-call").hide();u("#onvideocall").modal("hide");u(".btn.call-actions.video-call").show();console.group("onRejectCallListener.");console.log("UserId: "+t);console.log("Session: "+n);console.log("Extension: "+JSON.stringify(r));console.groupEnd();var f=_.findWhere(i.users,{id:+t}),e=_.findWhere(i.users,{id:+n.currentUserID});n.opponentsIDs.length===1||i.calleesRejected.push(userInfo)};t.webrtc.onRemoteStreamListener=function(n,r,f){console.group("onRemoteStreamListener.");console.log("userId: ",r);console.log("Session: ",n);console.log("Stream: ",f);console.groupEnd();var o=i.currentSession.connectionStateForUser(r),s=t.webrtc.PeerConnectionState;if(o===s.DISCONNECTED||o===s.FAILED||o===s.CLOSED)return!1;i.currentSession.peerConnections[r].stream=f;console.info("onRemoteStreamListener add video to the video element",f);i.currentSession.attachMediaStream("main_video",f);e.callTimer||(e.callTimer=setInterval(function(){e.updTimer.call(e)},1e3));u(".frames_callee__bitrate").show()};t.webrtc.onUserNotAnswerListener=function(n,t){console.group("onUserNotAnswerListener.");console.log("UserId: ",t);console.log("Session: ",n);console.groupEnd();var r=_.findWhere(i.users,{id:+t});n.opponentsIDs.length===1&&(u("#modal-video").modal("hide"),u(".btn.call-actions.video-call").show(),u("#onvideocall").modal("hide"),u(".btn-end-call").hide())};t.webrtc.onAcceptCallListener=function(n,t,r){var c,y,a,v,h;console.group("onAcceptCallListener.");console.log("UserId: ",t);console.log("Session: ",n);console.log("Extension: ",r);console.groupEnd();c=_.findWhere(i.users,{id:+t});y=u.trim(u(f.filterSelect).val());document.getElementById(s.call).pause();i.calleesAnwered.push(c);u("#modal-video").modal();u("#modal-video .video-user-sidebar").empty();var w=document.querySelector("#gorusulen li.contact.active"),b=w.cloneNode(!0),l=document.querySelector("#modal-video .video-user-sidebar");l.innerHtml="";l.appendChild(b);p=setInterval(function(){var n=u("#gorusulen li.contact.active .time"),t=n.attr("class");u("#modal-video .video-user-sidebar .time").removeClass("red").addClass(t).html(n.clone().html())},1e3);u("#modal-video .sidebar-buttons").empty();u(".taketime").clone().appendTo("#modal-video .sidebar-buttons");a="CHAT'E DÖN";v=u('<a class="returnchat btn" href="javascript:void(0);" >'+a+"<\/a>");v.appendTo("#modal-video .sidebar-buttons");u(".btn-endconversation").clone().appendTo("#modal-video .sidebar-buttons").addClass("confirmendconversation").removeClass("btn-endconversation");u("#modal-video .confirmendconversation").addClass("btn").removeClass("d-flex").removeClass("justify-content-end").removeClass("mr-md-0").removeClass("mr-6");var e=u(".candidateinfo"),k=e.find(".cedu-level").text(),d=e.find(".cedu-uni").text(),nt=e.find(".cedu-prog").text(),tt=e.find(".cedu-startdate").text(),it=e.find(".cedu-finishdate").text(),rt=e.find(".cedu-score").text(),ut=e.find(".cpositionlevel-value").text(),ft=e.find(".cpositionlevel-departments").text(),o=u(".u-infos");o.find(".edu-level").text(k);o.find(".edu-uni").text(d);o.find(".edu-prog").text(nt);o.find(".edu-startdate").text(tt);o.find(".edu-finishdate").text(it);o.find(".edu-score").text(rt);o.find(".positionlevel-value").text(ut);o.find(".positionlevel-departments").text(ft);h=u("#gorusulen li.contact.active").attr("id");u(".btn-savenotes").data("candidateId",h);g(h);u("#onvideocall").modal("hide")};t.webrtc.onSessionConnectionStateChangedListener=function(n,r,o){var h,v;console.group("onSessionConnectionStateChangedListener.");console.log("UserID:",r);console.log("Session:",n);console.log("Сonnection state:",o,w[o]);console.groupEnd();var a=_.invert(t.webrtc.SessionConnectionState)[o],c=u(".j-callee_status_"+r),l=!1;if(o===t.webrtc.SessionConnectionState.CONNECTING&&c.text(a),o===t.webrtc.SessionConnectionState.CONNECTED&&(i.helpers.toggleRemoteVideoView(r,"show"),c.text(a),u(".btn.call-actions.video-call").show()),o===t.webrtc.SessionConnectionState.COMPLETED&&(i.helpers.toggleRemoteVideoView(r,"show"),c.text("connected")),o===t.webrtc.SessionConnectionState.DISCONNECTED&&(i.helpers.toggleRemoteVideoView(r,"hide"),c.text("disconnected")),o===t.webrtc.SessionConnectionState.CLOSED){if(i.helpers.toggleRemoteVideoView(r,"clear"),i.mainVideo===r){u("#remote_video_"+r).removeClass("active");i.helpers.changeFilter("#main_video","no");i.mainVideo=0;for(h in i.currentSession.peerConnections)if(h!=r&&i.currentSession.peerConnections[h].stream!==undefined&&i.currentSession.peerConnections[h].stream.active){i.currentSession.attachMediaStream("main_video",i.currentSession.peerConnections[h].stream);i.mainVideo=h;break}}_.isEmpty(i.currentSession)||(Object.keys(i.currentSession.peerConnections).length===1||r===i.currentSession.initiatorID)&&(u(f.income_call).modal("hide"),document.getElementById(s.rington).pause());l=_.every(i.currentSession.peerConnections,function(n){return n.iceConnectionState==="closed"});l&&(i.helpers.changeFilter("#localVideo","no"),i.helpers.changeFilter("#main_video","no"),u(f.filterSelect).val("no"),i.calleesAnwered=[],i.calleesRejected=[],i.network[r]=null);i.currentSession.currentUserID!==i.currentSession.initiatorID||l||(v=_.findWhere(i.users,{id:+r}),i.calleesAnwered=_.reject(i.calleesAnwered,function(n){return n.id===+r}),i.calleesRejected.push(v),i.helpers.stateBoard.update({title:"tpl_call_status",property:{users:i.helpers.getUsersStatus()}}));(_.isEmpty(i.currentSession)||l)&&e.callTimer&&(u("#timer").addClass("invisible"),clearInterval(e.callTimer),e.callTimer=null,e.callTime=0,i.helpers.network={})}}})})(window,window.QB,window.app,window.CONFIG,jQuery,Backbone);